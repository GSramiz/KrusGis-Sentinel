<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KrusGis Sentinel Browser</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* –¢–≤–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π CSS –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            color: #333;
            overflow: hidden;
        }

        #app-container {
            display: flex;
            height: 100vh;
        }

        /* –°–∞–π–¥–±–∞—Ä —Å –∫–æ–Ω—Ç—Ä–æ–ª–∞–º–∏ */
        #control-panel {
            width: 320px;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-section {
            background: white;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .control-section h3 {
            margin-bottom: 12px;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #555;
        }

        input[type="date"], input[type="range"], select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 13px;
        }

        input[type="range"] {
            padding: 0;
        }

        .range-value {
            display: inline-block;
            width: 30px;
            text-align: right;
            font-weight: 600;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            transition: background 0.2s;
        }

        button:hover {
            background: #218838;
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        /* –û–±–ª–∞—Å—Ç—å –∫–∞—Ä—Ç—ã */
        #map-container {
            flex: 1;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #28a745;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è Leaflet */
        .leaflet-top.leaflet-right .leaflet-control {
            margin-right: 10px;
            margin-top: 10px;
        }

        /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª—å –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–Ω–∏–º–∫–µ */
        .image-info {
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px;
            font-size: 12px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Å–ª–µ–≤–∞) -->
        <div id="control-panel">
            <div class="control-section">
                <h3>üìÖ –í—Ä–µ–º–µ–Ω–Ω–æ–π –ø–µ—Ä–∏–æ–¥</h3>
                <div class="form-group">
                    <label for="start-date">–°:</label>
                    <input type="date" id="start-date">
                </div>
                <div class="form-group">
                    <label for="end-date">–ü–æ:</label>
                    <input type="date" id="end-date">
                </div>
            </div>

            <div class="control-section">
                <h3>‚òÅÔ∏è –§–∏–ª—å—Ç—Ä –æ–±–ª–∞—á–Ω–æ—Å—Ç–∏</h3>
                <div class="form-group">
                    <label>–ú–∞–∫—Å–∏–º—É–º: <span id="cloud-value" class="range-value">30</span>%</label>
                    <input type="range" id="cloud-filter" min="0" max="100" value="30">
                </div>
            </div>

            <div class="control-section">
                <h3>üé® –°–ø–µ–∫—Ç—Ä–∞–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã</h3>
                <div class="form-group">
                    <label for="layer-select">–†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
                    <select id="layer-select">
                        <option value="TRUE_COLOR">–ù–∞—Å—Ç–æ—è—â–∏–µ —Ü–≤–µ—Ç–∞ (RGB)</option>
                        <option value="FALSE_COLOR">–õ–æ–∂–Ω—ã–µ —Ü–≤–µ—Ç–∞</option>
                        <option value="NDVI">NDVI (–†–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)</option>
                        <option value="NDWI">NDWI (–í–æ–¥–∞)</option>
                    </select>
                </div>
            </div>

            <div class="control-section">
                <h3>‚öôÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="smoothing" checked>
                    <label for="smoothing">–°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ (–º–∞—Å–∫–∏—Ä–æ–≤–∫–∞ –æ–±–ª–∞–∫–æ–≤)</label>
                </div>
            </div>

            <button id="update-image">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–Ω–∏–º–æ–∫</button>
            
            <!-- –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
            <div class="control-section" id="info-section" style="display: none;">
                <h3>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <div id="image-info"></div>
            </div>
        </div>

        <!-- –ö–∞—Ä—Ç–∞ (–æ—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å) -->
        <div id="map-container">
            <div id="map"></div>
            <div class="loading-overlay" id="loading-overlay">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø - –ë–ê–ó–û–í–´–ô URL API
        // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
        const API_BASE_URL = 'http://localhost:5000';
        // –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ (–∑–∞–º–µ–Ω–∏ –Ω–∞ URL —Ç–≤–æ–µ–≥–æ PythonAnywhere):
        // const API_BASE_URL = 'https://—Ç–≤–æ–π-–ª–æ–≥–∏–Ω.pythonanywhere.com';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        const map = L.map('map').setView([55.7558, 37.6173], 6); // –¶–µ–Ω—Ç—Ä –Ω–∞ –†–æ—Å—Å–∏—é

        // –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–π —Å–ª–æ–π
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // –°–ª–æ–π –¥–ª—è —Å–ø—É—Ç–Ω–∏–∫–æ–≤—ã—Ö —Å–Ω–∏–º–∫–æ–≤
        let satelliteLayer = null;

        // –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        const startDateEl = document.getElementById('start-date');
        const endDateEl = document.getElementById('end-date');
        const cloudFilterEl = document.getElementById('cloud-filter');
        const cloudValueEl = document.getElementById('cloud-value');
        const layerSelectEl = document.getElementById('layer-select');
        const smoothingEl = document.getElementById('smoothing');
        const updateButtonEl = document.getElementById('update-image');
        const loadingOverlayEl = document.getElementById('loading-overlay');
        const infoSectionEl = document.getElementById('info-section');
        const imageInfoEl = document.getElementById('image-info');

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 30);

        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã –¥–ª—è input[type="date"]
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        startDateEl.value = formatDate(startDate);
        endDateEl.value = formatDate(endDate);

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ–±–ª–∞—á–Ω–æ—Å—Ç–∏
        cloudFilterEl.addEventListener('input', function() {
            cloudValueEl.textContent = this.value;
        });

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
        function setLoading(loading) {
            loadingOverlayEl.style.display = loading ? 'flex' : 'none';
            updateButtonEl.disabled = loading;
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–Ω–∏–º–∫–µ
        function updateImageInfo(result) {
            if (result.success && result.layer_info) {
                imageInfoEl.innerHTML = `
                    <strong>–°–ª–æ–π:</strong> ${result.layer_info.description}<br>
                    <strong>–°–Ω–∏–º–∫–æ–≤ –Ω–∞–π–¥–µ–Ω–æ:</strong> ${result.image_count}<br>
                    <strong>–°—Ç–∞—Ç—É—Å:</strong> ‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
                `;
                infoSectionEl.style.display = 'block';
            } else {
                infoSectionEl.style.display = 'none';
            }
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–Ω–∏–º–∫–∞
        async function updateSatelliteImage() {
            try {
                setLoading(true);

                const bounds = map.getBounds();
                const requestData = {
                    bounds: [
                        bounds.getSouthWest().lng,
                        bounds.getSouthWest().lat,
                        bounds.getNorthEast().lng,
                        bounds.getNorthEast().lat
                    ],
                    start_date: startDateEl.value,
                    end_date: endDateEl.value,
                    cloud_filter: parseInt(cloudFilterEl.value),
                    smoothing: smoothingEl.checked,
                    layer: layerSelectEl.value
                };

                console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', requestData);

                // –í—ã–∑–æ–≤ —Ç–≤–æ–µ–≥–æ Flask API —Å –±–∞–∑–æ–≤—ã–º URL
                const response = await fetch(`${API_BASE_URL}/api/get_sentinel_image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', result);

                if (result.success) {
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Å–ª–æ–π –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (satelliteLayer) {
                        map.removeLayer(satelliteLayer);
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Å–ª–æ–π —Å —Ç–∞–π–ª–∞–º–∏
                    satelliteLayer = L.tileLayer(result.tile_url, {
                        attribution: '¬© Sentinel-2, Google Earth Engine',
                        maxZoom: 18
                    }).addTo(map);

                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                    updateImageInfo(result);
                    
                    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–Ω–∏–º–∫–æ–≤: ${result.image_count}`);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                    infoSectionEl.style.display = 'none';
                }

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–Ω–∏–º–∫–∞: ' + error.message);
                infoSectionEl.style.display = 'none';
            } finally {
                setLoading(false);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏
        updateButtonEl.addEventListener('click', updateSatelliteImage);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ (—á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã)
        setTimeout(updateSatelliteImage, 2000);
    </script>
</body>
</html>
